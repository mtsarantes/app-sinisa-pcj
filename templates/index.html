<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SINISA PCJ - Eficiência</title>
    <style>
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;margin:0;padding:16px;background-color:#f0f2f5;color:#333}h1,h2,h3{color:#1c5a9b}h2{border-bottom:2px solid #1c5a9b;padding-bottom:8px}main{background-color:#fff;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,.1);padding:16px;margin-top:24px}.search-container{display:flex;gap:8px;margin-bottom:24px}#municipio-select{flex-grow:1;padding:12px;border:1px solid #ccc;border-radius:6px;font-size:1rem;background-color:#fff}#search-button{padding:12px 16px;border:none;background-color:#1c5a9b;color:#fff;border-radius:6px;font-size:1rem;cursor:pointer}.info-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px;margin-top:16px}.card{background-color:#f9f9f9;padding:16px;border-radius:6px;border:1px solid #ddd}.card h3{margin-top:0;margin-bottom:8px}.card p{margin:0;font-size:1.1rem;font-weight:700}.details-section{margin-top:24px;display:none}.charts-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:24px;margin-top:24px}.table-container{overflow-x:auto}.ranking-table{width:100%;border-collapse:collapse;margin-top:16px}.ranking-table th,.ranking-table td{border:1px solid #ddd;padding:8px;text-align:left}.ranking-table th{background-color:#e9e9e9;color:#555}.comparison{font-weight:700}.comparison.better{color:#28a745}.comparison.worse{color:#dc3545}.spinner-container{text-align:center;padding:20px}.loader{border:4px solid #f3f3f3;border-top:4px solid #1c5a9b;border-radius:50%;width:30px;height:30px;animation:spin 1s linear infinite}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    </style>
</head>
<body>

    <main>
        <h1>Painel de Indicadores de Eficiência SINISA PCJ</h1>

        <section id="search-section">
            <h2>Buscar por Município</h2>
            <div class="search-container">
                <select id="municipio-select">
                    <option value="">Carregando...</option>
                </select>
                <button id="search-button">Buscar</button>
            </div>
            <div id="municipio-details" class="details-section">
                <h3 id="municipio-titulo"></h3>
                <div class="info-grid">
                    <div class="card">
                        <h3>Perdas na Distribuição (%)</h3>
                        <p id="perdas_percentual_municipio"></p>
                    </div>
                    <div class="card">
                        <h3>Perdas por Ligação (L/dia/ligação)</h3>
                        <p id="perdas_por_ligacao_municipio"></p>
                    </div>
                    <div class="card">
                        <h3>Índice de Tratamento de Esgoto (%)</h3>
                        <p id="indice_tratamento_esgoto_municipio"></p>
                    </div>
                </div>
            </div>
            <div id="no-data" style="display:none; text-align: center; color: red;">Município não encontrado ou dados indisponíveis.</div>
        </section>

        <section id="bacia-section">
            <h2>Médias da Bacia PCJ</h2>
            <div class="info-grid">
                <div class="card">
                    <h3>Perdas na Distribuição (%)</h3>
                    <p id="perdas-bacia"></p>
                </div>
                <div class="card">
                    <h3>Perdas por Ligação (L/dia/ligação)</h3>
                    <p id="perdas-ligacao-bacia"></p>
                </div>
                <div class="card">
                    <h3>Índice de Tratamento de Esgoto (%)</h3>
                    <p id="esgoto-bacia"></p>
                </div>
            </div>
        </section>

        <section id="charts-section">
            <h2>Comparativo de Ranking</h2>
            <div class="charts-container">
                <div class="chart-box">
                    <h3>Perdas na Distribuição (%)</h3>
                    <div class="table-container">
                        <table class="ranking-table">
                            <thead>
                                <tr>
                                    <th>Posição</th>
                                    <th>Município</th>
                                    <th>Valor</th>
                                </tr>
                            </thead>
                            <tbody id="ranking-percentual-body">
                                <tr><td colspan="3" class="spinner-container"><div class="loader"></div></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="chart-box">
                    <h3>Perdas por Ligação (L/dia/ligação)</h3>
                    <div class="table-container">
                        <table class="ranking-table">
                            <thead>
                                <tr>
                                    <th>Posição</th>
                                    <th>Município</th>
                                    <th>Valor</th>
                                </tr>
                            </thead>
                            <tbody id="ranking-ligacao-body">
                                <tr><td colspan="3" class="spinner-container"><div class="loader"></div></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

    </main>
    <script>
        let baciaValores = {};

        function formatarNumero(e,t=2){if(null==e)return"N/D";const n=Number(String(e).replace(",","."));return!isNaN(n)?n.toFixed(t).replace(".",","):e}

        async function carregarDadosBacia(){
            try{
                const t=await fetch("/api/bacia/valores");
                const n=await t.json();
                baciaValores=n;
                document.getElementById("perdas-bacia").textContent=formatarNumero(n.perdas_percentual)+"%";
                document.getElementById("perdas-ligacao-bacia").textContent=formatarNumero(n.perdas_por_ligacao);
                document.getElementById("esgoto-bacia").textContent=formatarNumero(n.indice_tratamento_esgoto)+"%"
            } catch(e){
                console.error("Erro ao carregar dados da bacia:",e);
                document.getElementById("perdas-bacia").textContent="Erro!";
                document.getElementById("perdas-ligacao-bacia").textContent="Erro!";
                document.getElementById("esgoto-bacia").textContent="Erro!"
            }
        }

        async function carregarRankingPercentual(){
            const e=document.getElementById("ranking-percentual-body");
            try{
                const t=await fetch("/api/ranking/perdas"),a=await t.json();e.innerHTML="",a.forEach(t=>{const a=document.createElement("tr");const n=Number(String(t.perdas_percentual).replace(",","."));let r="<td>";n>baciaValores.perdas_percentual&&(r='<td class="comparison worse">');
                a.innerHTML=`<td>${t.Posicao}</td><td>${t.Municipio}</td>${r}${formatarNumero(t.perdas_percentual)}%</td>`;
                e.appendChild(a)
            })}catch(t){
                console.error("Erro ranking %:",t);
                e.innerHTML='<tr><td colspan="3" style="text-align: center; color: red;">Erro!</td></tr>'
            }
        }

        async function carregarRankingLigacao(){
            const e=document.getElementById("ranking-ligacao-body");
            try{
                const t=await fetch("/api/ranking/perdas_por_ligacao"),a=await t.json();e.innerHTML="",a.forEach(t=>{const a=document.createElement("tr");
                const n=Number(String(t.perdas_por_ligacao).replace(",","."));
                let r="<td>";
                n>baciaValores.perdas_por_ligacao&&(r='<td class="comparison worse">');
                a.innerHTML=`<td>${t.Posicao}</td><td>${t.Municipio}</td>${r}${formatarNumero(t.perdas_por_ligacao)}</td>`;
                e.appendChild(a)
            })}catch(t){
                console.error("Erro ranking perdas/lig:",t);
                e.innerHTML='<tr><td colspan="3" style="text-align: center; color: red;">Erro!</td></tr>'
            }
        }

        async function carregarDadosMunicipios(){
            const e=document.getElementById("municipio-select");
            try{
                const t=await fetch("/api/municipios"),n=await t.json();e.innerHTML='<option value="">Selecione um município...</option>',n.forEach(t=>{const n=document.createElement("option");n.value=t,n.textContent=t,e.appendChild(n)})
            }catch(t){
                console.error("Erro ao carregar municípios:",t);
                e.innerHTML='<option value="">Erro ao carregar</option>'
            }
        }

        async function buscarDadosMunicipios(){
            const t=document.getElementById("municipio-select").value;
            const e=document.getElementById("municipio-details");
            const n=document.getElementById("no-data");
            if(t){
                try{
                    const a=await fetch(`/api/municipio/${t}`);
                    if(a.status===404){
                        e.style.display="none",n.style.display="block"
                    }else{
                        const i=await a.json();
                        n.style.display="none",
                        e.style.display="block",
                        document.getElementById("municipio-titulo").textContent=i.Municipio,
                        document.getElementById("perdas_percentual_municipio").textContent=formatarNumero(i.perdas_percentual)+"%",
                        document.getElementById("perdas_por_ligacao_municipio").textContent=formatarNumero(i.perdas_por_ligacao),
                        document.getElementById("indice_tratamento_esgoto_municipio").textContent=formatarNumero(i.indice_tratamento_esgoto)+"%"
                    }
                }catch(t){
                    console.error("Erro ao buscar dados do município:",t),e.style.display="none",n.style.display="block"
                }
            }else{
                e.style.display="none",n.style.display="none"
            }
        }

        document.getElementById("search-button").addEventListener("click",buscarDadosMunicipios);
        document.addEventListener("DOMContentLoaded",()=>{
            carregarDadosBacia().then(()=>{
                carregarRankingPercentual(),
                carregarRankingLigacao(),
                carregarDadosMunicipios()
            })
        });
    </script>
</body>
</html>
