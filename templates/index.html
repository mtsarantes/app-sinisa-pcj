<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SINISA PCJ - Eficiência</title>
    <style>
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;margin:0;padding:16px;background-color:#f0f2f5;color:#333}h1,h2,h3{color:#1c5a9b}h2{border-bottom:2px solid #1c5a9b;padding-bottom:8px}main{background-color:#fff;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,.1);padding:16px;margin-top:24px}.search-container{display:flex;gap:8px;margin-bottom:24px}#municipio-select{flex-grow:1;padding:12px;border:1px solid #ccc;border-radius:6px;font-size:1rem;background-color:#fff}#search-button{padding:12px 16px;border:none;background-color:#1c5a9b;color:#fff;border-radius:6px;font-size:1rem;cursor:pointer}.info-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px}.info-item{background-color:#f8f9fa;padding:12px;border-radius:6px;border-left:4px solid #1c5a9b}.info-item .label{font-weight:700;color:#333;display:block;margin-bottom:4px}.info-item .value{font-size:1.1rem;color:#555}
        .meta-status { font-size: 0.85rem; margin-top: 4px; border-top: 1px solid #eee; padding-top: 4px; }
        .status-met { color: green; font-weight: bold; }
        .status-not-met { color: red; font-weight: bold; }
        .comparison { font-size: 0.85rem; margin-top: 4px; font-weight: bold; }
        .comparison.worse { color: red; }
        .comparison.better { color: green; }
        table{width:100%;border-collapse:collapse;margin-top:16px}th,td{padding:12px 16px;text-align:left;border-bottom:1px solid #e0e0e0}thead{background-color:#1c5a9b;color:#fff}tbody tr:nth-child(even){background-color:#f8f9fa}td:first-child,th:first-child{text-align:center;font-weight:700}
        footer{text-align:center;margin-top:32px;padding-top:20px;border-top:1px solid #ccc;font-size:.9rem;color:#666}
    </style>
</head>
<body>
    <header style="text-align: center;"><h1>Consulta de Eficiência Hídrica - Bacias PCJ</h1></header>

    <main>
        <h2>Dados Gerais da Bacia PCJ</h2>
        <div class="info-grid">
            <div class="info-item"><span class="label">População Total</span><span class="value">6.504.659</span></div>
            <div class="info-item"><span class="label">População Rural</span><span class="value">316.804</span></div>
            <div class="info-item"><span class="label">Volume Produzido (mil m³/ano)</span><span class="value">671.067,69</span></div>
            <div class="info-item"><span class="label">Volume Consumido (mil m³/ano)</span><span class="value">421.075,29</span></div>
            <div class="info-item"><span class="label">Índice de Perdas (%)</span><span class="value">35,44%</span> <div class="meta-status"><span class="status-not-met">Meta do Plano: 25,00%</span></div></div>
            <div class="info-item"><span class="label">Índice de Perdas por Ligação</span><span class="value">296,25 L/lig/dia</span></div>
        </div>
    </main>

    <main>
        <h2>Consulta por Município</h2>
        <div class="search-container">
            <select id="municipio-select"><option value="">Selecione um município...</option></select>
            <button id="search-button">Buscar</button>
        </div>
        <div id="municipio-resultado"></div>
    </main>
    
    <main style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
        <div>
            <h2>Ranking: Perdas (%)</h2>
            <table id="ranking-percentual-table">
                <thead><tr><th>Pos.</th><th>Município</th><th>Índice</th></tr></thead>
                <tbody id="ranking-percentual-body"><tr><td colspan="3" style="text-align: center;">...</td></tr></tbody>
            </table>
        </div>
        <div>
            <h2>Ranking: Perdas por Ligação (L/dia)</h2>
            <table id="ranking-ligacao-table">
                <thead><tr><th>Pos.</th><th>Município</th><th>Índice</th></tr></thead>
                <tbody id="ranking-ligacao-body"><tr><td colspan="3" style="text-align: center;">...</td></tr></tbody>
            </table>
        </div>
    </main>
    
    <footer>Desenvolvido por: Câmara Técnica de Saneamento.</footer>

    <script>
        const baciaValores = { perdas_percentual: 35.44, perdas_por_ligacao: 296.25 };
        function formatarNumero(valor, casasDecimais = 2) { if (valor === 'N/D' || valor === null || valor === undefined) return 'N/D'; const numero = Number(String(valor).replace(",",".")); if (isNaN(numero)) { return 'N/D'; } return numero.toLocaleString('pt-BR', { minimumFractionDigits: casasDecimais, maximumFractionDigits: casasDecimais }); }
        
        const searchButton=document.getElementById("search-button"),municipioSelect=document.getElementById("municipio-select"),resultadoDiv=document.getElementById("municipio-resultado");
        
        async function buscarMunicipio(){
            const municipioNome=municipioSelect.value;
            if(!municipioNome){resultadoDiv.innerHTML='<p style="color: orange;">Selecione um município.</p>'; return;}
            resultadoDiv.innerHTML="<p>Buscando...</p>";
            try {
                const response = await fetch(`/api/municipio/${municipioNome}`);
                const municipio = await response.json();
                if (municipio.erro) { resultadoDiv.innerHTML = `<p style="color: red;">${municipio.erro}</p>`; return; }
                
                function getComparisonToBasin(valorMunicipio, valorBacia) { if (valorBacia === null || valorMunicipio === 'N/D') return ''; const valMun = Number(String(valorMunicipio).replace(",",".")); if (isNaN(valMun)) return ''; const diff = ((valMun / valorBacia) - 1) * 100; const isWorse = diff > 0; const text = isWorse ? `${formatarNumero(diff)}% pior que a bacia` : `${formatarNumero(Math.abs(diff))}% melhor que a bacia`; const className = isWorse ? 'worse' : 'better'; return `<div class="comparison ${className}">${text}</div>`; }
                function getComparisonTo2025Goal(valorAtual, meta2025) { if (meta2025 === 'N/D' || valorAtual === 'N/D' || !meta2025) return '<div class="meta-status">Meta 2025: N/D</div>'; const valAtualNum = Number(String(valorAtual).replace(",",".")); const metaNum = Number(meta2025); if(isNaN(valAtualNum) || isNaN(metaNum)) return '<div class="meta-status">Meta 2025: N/D</div>'; const status = valAtualNum <= metaNum ? '<span class="status-met">Atingida</span>' : '<span class="status-not-met">Não Atingida</span>'; return `<div class="meta-status">Meta 2025: ${formatarNumero(metaNum)}% (${status})</div>`; }
                
                resultadoDiv.innerHTML = `
                    <h3>Dados Gerais: ${municipio.Municipio}</h3>
                    <div class="info-grid">
                        <div class="info-item"><span class="label">População Total</span><span class="value">${formatarNumero(municipio.pop_total, 0)}</span></div>
                        <div class="info-item"><span class="label">% Pop. Urbana</span><span class="value">${formatarNumero(municipio.pct_pop_urbana)} %</span></div>
                        <div class="info-item"><span class="label">% Pop. Rural</span><span class="value">${formatarNumero(municipio.pct_pop_rural)} %</span></div>
                        <div class="info-item"><span class="label">Volume Produzido</span><span class="value">${formatarNumero(municipio.vol_produzido)} mil m³/ano</span></div>
                        <div class="info-item"><span class="label">Volume Consumido</span><span class="value">${formatarNumero(municipio.vol_consumido)} mil m³/ano</span></div>
                        <div class="info-item"><span class="label">Volume Micromedido</span><span class="value">${formatarNumero(municipio.vol_micromedido)} mil m³/ano</span></div>
                    </div>
                    
                    <h3 style="margin-top: 24px;">Indicadores de Perdas</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="label">Perdas na Distribuição (%)</span>
                            <span class="value">${formatarNumero(municipio.perdas_percentual)} %</span>
                            ${getComparisonToBasin(municipio.perdas_percentual, baciaValores.perdas_percentual)}
                            ${getComparisonTo2025Goal(municipio.perdas_percentual, municipio.Meta_2025)}
                        </div>
                        <div class="info-item"><span class="label">Perdas por Ligação (L/dia)</span><span class="value">${formatarNumero(municipio.perdas_por_ligacao)} L/lig/dia</span> ${getComparisonToBasin(municipio.perdas_por_ligacao, baciaValores.perdas_por_ligacao)}</div>
                        <div class="info-item"><span class="label">Perdas Lineares</span><span class="value">${formatarNumero(municipio.perdas_lineares)} m³/km/dia</span></div>
                        <div class="info-item"><span class="label">Incidência de Setorização</span><span class="value">${formatarNumero(municipio.incidencia_setorizadas)} %</span></div>
                    </div>`;

            } catch(e) { console.error("Erro na busca:",e); resultadoDiv.innerHTML='<p style="color: red;">Falha na conexão.</p>'; }
        }
        searchButton.addEventListener("click", buscarMunicipio);
        
        async function carregarDadosIniciais(){
            async function carregarMunicipios(){try{const e=await fetch("/api/municipios"),t=await e.json();t.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,municipioSelect.appendChild(t)})}catch(e){console.error("Erro ao carregar municípios",e)}}
            async function carregarRankingPercentual(){const e=document.getElementById("ranking-percentual-body");try{const t=await fetch("/api/ranking/perdas"),a=await t.json();e.innerHTML="",a.forEach(t=>{const a=document.createElement("tr");const n=Number(String(t.perdas_percentual).replace(",","."));let r="<td>";n>baciaValores.perdas_percentual&&(r='<td class="comparison worse">'),a.innerHTML=`<td>${t.Posicao}</td><td>${t.Municipio}</td>${r}${formatarNumero(t.perdas_percentual)}%</td>`,e.appendChild(a)})}catch(t){console.error("Erro ranking %:",t),e.innerHTML='<tr><td colspan="3" style="text-align: center; color: red;">Erro!</td></tr>'}}
            async function carregarRankingLigacao(){const e=document.getElementById("ranking-ligacao-body");try{const t=await fetch("/api/ranking/perdas_por_ligacao"),a=await t.json();e.innerHTML="",a.forEach(t=>{const a=document.createElement("tr");const n=Number(String(t.perdas_por_ligacao).replace(",","."));let r="<td>";n>baciaValores.perdas_por_ligacao&&(r='<td class="comparison worse">'),a.innerHTML=`<td>${t.Posicao}</td><td>${t.Municipio}</td>${r}${formatarNumero(t.perdas_por_ligacao)}</td>`,e.appendChild(a)})}catch(t){console.error("Erro ranking ligação:",t),e.innerHTML='<tr><td colspan="3" style="text-align: center; color: red;">Erro!</td></tr>'}}
            carregarMunicipios();
            carregarRankingPercentual();
            carregarRankingLigacao();
        }
        window.onload = carregarDadosIniciais;
    </script>
</body>
</html><!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SINISA PCJ - Eficiência</title>
    <style>
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;margin:0;padding:16px;background-color:#f0f2f5;color:#333}h1,h2,h3{color:#1c5a9b}h2{border-bottom:2px solid #1c5a9b;padding-bottom:8px}main{background-color:#fff;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,.1);padding:16px;margin-top:24px}.search-container{display:flex;gap:8px;margin-bottom:24px}#municipio-select{flex-grow:1;padding:12px;border:1px solid #ccc;border-radius:6px;font-size:1rem;background-color:#fff}#search-button{padding:12px 16px;border:none;background-color:#1c5a9b;color:#fff;border-radius:6px;font-size:1rem;cursor:pointer}.info-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px}.info-item{background-color:#f8f9fa;padding:12px;border-radius:6px;border-left:4px solid #1c5a9b}.info-item .label{font-weight:700;color:#333;display:block;margin-bottom:4px}.info-item .value{font-size:1.1rem;color:#555}
        .meta-status { font-size: 0.85rem; margin-top: 4px; border-top: 1px solid #eee; padding-top: 4px; }
        .status-met { color: green; font-weight: bold; }
        .status-not-met { color: red; font-weight: bold; }
        .comparison { font-size: 0.85rem; margin-top: 4px; font-weight: bold; }
        .comparison.worse { color: red; }
        .comparison.better { color: green; }
        table{width:100%;border-collapse:collapse;margin-top:16px}th,td{padding:12px 16px;text-align:left;border-bottom:1px solid #e0e0e0}thead{background-color:#1c5a9b;color:#fff}tbody tr:nth-child(even){background-color:#f8f9fa}td:first-child,th:first-child{text-align:center;font-weight:700}
        footer{text-align:center;margin-top:32px;padding-top:20px;border-top:1px solid #ccc;font-size:.9rem;color:#666}
        .spinner-container{text-align:center;padding:20px}.loader{border:4px solid #f3f3f3;border-top:4px solid #1c5a9b;border-radius:50%;width:30px;height:30px;animation:spin 1s linear infinite}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    </style>
</head>
<body>
    <header style="text-align: center;"><h1>Consulta de Eficiência Hídrica - Bacias PCJ</h1></header>

    <main>
        <h2>Dados Gerais da Bacia PCJ</h2>
        <div class="info-grid">
            <div class="info-item"><span class="label">População Total</span><span class="value">6.504.659</span></div>
            <div class="info-item"><span class="label">População Rural</span><span class="value">316.804</span></div>
            <div class="info-item"><span class="label">Volume Produzido (mil m³/ano)</span><span class="value">671.067,69</span></div>
            <div class="info-item"><span class="label">Volume Consumido (mil m³/ano)</span><span class="value">421.075,29</span></div>
            <div class="info-item"><span class="label">Índice de Perdas (%)</span><span class="value" id="perdas-bacia">Carregando...</span></div>
            <div class="info-item"><span class="label">Índice de Perdas por Ligação</span><span class="value" id="perdas-ligacao-bacia">Carregando...</span></div>
        </div>
    </main>

    <main>
        <h2>Consulta por Município</h2>
        <div class="search-container">
            <select id="municipio-select"><option value="">Carregando...</option></select>
            <button id="search-button">Buscar</button>
        </div>
        <div id="municipio-resultado"></div>
    </main>
    
    <main style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
        <div>
            <h2>Ranking: Perdas (%)</h2>
            <table id="ranking-percentual-table">
                <thead><tr><th>Pos.</th><th>Município</th><th>Índice</th></tr></thead>
                <tbody id="ranking-percentual-body"><tr><td colspan="3" class="spinner-container"><div class="loader"></div></td></tr></tbody>
            </table>
        </div>
        <div>
            <h2>Ranking: Perdas por Ligação (L/dia)</h2>
            <table id="ranking-ligacao-table">
                <thead><tr><th>Pos.</th><th>Município</th><th>Índice</th></tr></thead>
                <tbody id="ranking-ligacao-body"><tr><td colspan="3" class="spinner-container"><div class="loader"></div></td></tr></tbody>
            </table>
        </div>
    </main>
    
    <footer>Desenvolvido por: Câmara Técnica de Saneamento.</footer>

    <script>
        let baciaValores = {};
        
        function formatarNumero(valor, casasDecimais = 2) { 
            if (valor === 'N/D' || valor === null || valor === undefined) return 'N/D'; 
            const numero = Number(String(valor).replace(",",".")); 
            if (isNaN(numero)) { return 'N/D'; } 
            return numero.toLocaleString('pt-BR', { minimumFractionDigits: casasDecimais, maximumFractionDigits: casasDecimais }); 
        }

        const searchButton = document.getElementById("search-button");
        const municipioSelect = document.getElementById("municipio-select");
        const resultadoDiv = document.getElementById("municipio-resultado");
        const perdasBaciaSpan = document.getElementById("perdas-bacia");
        const perdasLigacaoBaciaSpan = document.getElementById("perdas-ligacao-bacia");
        const rankingPercentualBody = document.getElementById("ranking-percentual-body");
        const rankingLigacaoBody = document.getElementById("ranking-ligacao-body");

        async function carregarDadosBacia(){
            try {
                const response = await fetch("/api/bacia/valores");
                const n = await response.json();
                baciaValores = n;
                perdasBaciaSpan.textContent = formatarNumero(n.perdas_percentual) + "%";
                perdasLigacaoBaciaSpan.textContent = formatarNumero(n.perdas_por_ligacao) + " L/lig/dia";
            } catch(e) {
                console.error("Erro ao carregar dados da bacia:", e);
                perdasBaciaSpan.textContent = "Erro!";
                perdasLigacaoBaciaSpan.textContent = "Erro!";
            }
        }
        
        async function carregarMunicipios(){
            try {
                const response = await fetch("/api/municipios");
                const municipios = await response.json();
                municipioSelect.innerHTML = '<option value="">Selecione um município...</option>';
                municipios.forEach(mun => {
                    const option = document.createElement("option");
                    option.value = mun; // O valor já virá capitalizado da API
                    option.textContent = mun;
                    municipioSelect.appendChild(option);
                });
            } catch(e) {
                console.error("Erro ao carregar municípios:", e);
                municipioSelect.innerHTML = '<option value="">Erro ao carregar</option>';
            }
        }
        
        async function carregarRankingPercentual(){
            try {
                const response = await fetch("/api/ranking/perdas");
                const ranking = await response.json();
                rankingPercentualBody.innerHTML = "";
                ranking.forEach(mun => {
                    const row = document.createElement("tr");
                    const perdas = Number(String(mun.perdas_percentual).replace(",", "."));
                    let tdClass = "<td>";
                    if (perdas > baciaValores.perdas_percentual) {
                        tdClass = '<td class="comparison worse">';
                    }
                    row.innerHTML = `<td>${mun.Posicao}</td><td>${mun.Municipio}</td>${tdClass}${formatarNumero(mun.perdas_percentual)}%</td>`;
                    rankingPercentualBody.appendChild(row);
                });
            } catch(e) {
                console.error("Erro ao carregar ranking %:", e);
                rankingPercentualBody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: red;">Erro!</td></tr>';
            }
        }
        
        async function carregarRankingLigacao(){
            try {
                const response = await fetch("/api/ranking/perdas_por_ligacao");
                const ranking = await response.json();
                rankingLigacaoBody.innerHTML = "";
                ranking.forEach(mun => {
                    const row = document.createElement("tr");
                    const perdas = Number(String(mun.perdas_por_ligacao).replace(",", "."));
                    let tdClass = "<td>";
                    if (perdas > baciaValores.perdas_por_ligacao) {
                        tdClass = '<td class="comparison worse">';
                    }
                    row.innerHTML = `<td>${mun.Posicao}</td><td>${mun.Municipio}</td>${tdClass}${formatarNumero(mun.perdas_por_ligacao)}</td>`;
                    rankingLigacaoBody.appendChild(row);
                });
            } catch(e) {
                console.error("Erro ao carregar ranking perdas/lig:", e);
                rankingLigacaoBody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: red;">Erro!</td></tr>';
            }
        }

        async function buscarMunicipio(){
            const municipioNome = municipioSelect.value;
            if(!municipioNome){
                resultadoDiv.innerHTML = '<p style="color: orange;">Selecione um município.</p>'; 
                return;
            }
            resultadoDiv.innerHTML = "<p>Buscando...</p>";
            try {
                // Passando o valor para minúsculas na requisição para corresponder ao backend
                const response = await fetch(`/api/municipio/${municipioNome.toLowerCase()}`);
                const municipio = await response.json();
                if (municipio.erro) { 
                    resultadoDiv.innerHTML = `<p style="color: red;">${municipio.erro}</p>`; 
                    return; 
                }
                
                function getComparisonToBasin(valorMunicipio, valorBacia) { 
                    if (valorBacia === null || valorMunicipio === 'N/D' || valorMunicipio === null) return ''; 
                    const valMun = Number(String(valorMunicipio).replace(",",".")); 
                    if (isNaN(valMun)) return ''; 
                    const diff = ((valMun / valorBacia) - 1) * 100; 
                    const isWorse = diff > 0; 
                    const text = isWorse ? `${formatarNumero(diff)}% pior que a bacia` : `${formatarNumero(Math.abs(diff))}% melhor que a bacia`; 
                    const className = isWorse ? 'worse' : 'better'; 
                    return `<div class="comparison ${className}">${text}</div>`; 
                }

                function getComparisonTo2025Goal(valorAtual, meta2025) { 
                    if (meta2025 === 'N/D' || valorAtual === 'N/D' || !meta2025 || valorAtual === null) return '<div class="meta-status">Meta 2025: N/D</div>'; 
                    const valAtualNum = Number(String(valorAtual).replace(",",".")); 
                    const metaNum = Number(meta2025); 
                    if(isNaN(valAtualNum) || isNaN(metaNum)) return '<div class="meta-status">Meta 2025: N/D</div>'; 
                    const status = valAtualNum <= metaNum ? '<span class="status-met">Atingida</span>' : '<span class="status-not-met">Não Atingida</span>'; 
                    return `<div class="meta-status">Meta 2025: ${formatarNumero(metaNum)}% (${status})</div>`; 
                }
                
                resultadoDiv.innerHTML = `
                    <h3>Dados Gerais: ${municipio.Municipio}</h3>
                    <div class="info-grid">
                        <div class="info-item"><span class="label">População Total</span><span class="value">${formatarNumero(municipio.pop_total, 0)}</span></div>
                        <div class="info-item"><span class="label">% Pop. Urbana</span><span class="value">${formatarNumero(municipio.pct_pop_urbana)} %</span></div>
                        <div class="info-item"><span class="label">% Pop. Rural</span><span class="value">${formatarNumero(municipio.pct_pop_rural)} %</span></div>
                        <div class="info-item"><span class="label">Volume Produzido</span><span class="value">${formatarNumero(municipio.vol_produzido)} mil m³/ano</span></div>
                        <div class="info-item"><span class="label">Volume Consumido</span><span class="value">${formatarNumero(municipio.vol_consumido)} mil m³/ano</span></div>
                        <div class="info-item"><span class="label">Volume Micromedido</span><span class="value">${formatarNumero(municipio.vol_micromedido)} mil m³/ano</span></div>
                    </div>
                    
                    <h3 style="margin-top: 24px;">Indicadores de Perdas</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="label">Perdas na Distribuição (%)</span>
                            <span class="value">${formatarNumero(municipio.perdas_percentual)} %</span>
                            ${getComparisonToBasin(municipio.perdas_percentual, baciaValores.perdas_percentual)}
                            ${getComparisonTo2025Goal(municipio.perdas_percentual, municipio.Meta_2025)}
                        </div>
                        <div class="info-item"><span class="label">Perdas por Ligação (L/dia)</span><span class="value">${formatarNumero(municipio.perdas_por_ligacao)} L/lig/dia</span> ${getComparisonToBasin(municipio.perdas_por_ligacao, baciaValores.perdas_por_ligacao)}</div>
                        <div class="info-item"><span class="label">Perdas Lineares</span><span class="value">${formatarNumero(municipio.perdas_lineares)} m³/km/dia</span></div>
                        <div class="info-item"><span class="label">Incidência de Setorização</span><span class="value">${formatarNumero(municipio.incidencia_setorizadas)} %</span></div>
                    </div>`;

            } catch(e) { 
                console.error("Erro na busca:", e); 
                resultadoDiv.innerHTML = '<p style="color: red;">Falha na conexão. Verifique se a sua API está funcionando corretamente.</p>'; 
            }
        }
        
        searchButton.addEventListener("click", buscarMunicipio);
        
        document.addEventListener("DOMContentLoaded", () => {
            carregarDadosBacia().then(() => {
                carregarMunicipios();
                carregarRankingPercentual();
                carregarRankingLigacao();
            });
        });
    </script>
</body>
</html>

